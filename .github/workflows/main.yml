name: Deploy Laravel App

on:
  push:
    branches:
      - main # Change this to your default branch if different

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Install PHP and Dependencies
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.2 # Use the PHP version compatible with your project
        extensions: mbstring, exif, bcmath, gd
        ini-values: post_max_size=256M, upload_max_filesize=256M
        coverage: none

    - name: Install Composer Dependencies
      run: composer install --no-dev --optimize-autoloader

    - name: Deploy via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./ # Laravel project root
        server-dir: /public_html/laravel-project # Update based on your cPanel directory

    - name: Run Laravel Artisan Commands
      run: |
        ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
        cd /home/username/public_html/laravel-project
        php artisan migrate --force
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache
        php artisan storage:link
        EOF
      if: ${{ secrets.SSH_ENABLED == 'true' }}
